#!/bin/sh
# If a remote branch `modulesync` exist, commits are added on top of it, but
# the branch itself will not be rebased on master.  After running msync update,
# you will want to rebase on master.

set -e

for repo in modules/*/*; do
	(
		echo "===> ${repo}"
		cd $repo
		main_branch_name=$(git symbolic-ref refs/remotes/origin/HEAD | sed -e 's|refs/remotes/origin/||')
		git fetch --all
		git rebase origin/$main_branch_name
		git push -fu origin modulesync
	)
done
